<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panier</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"
        nonce="<%= nonce %>">
</head>

<body>
    <%- include('partials/header') %>
        <div class="container my-4">
            <h1>Votre panier</h1>
            <div id="panierContent" class="mt-3">
                <!-- Les éléments du panier seront affichés ici -->
            </div>
            <button id="viderPanier" class="btn btn-danger mt-3">Vider le panier</button>
        </div>

        <script nonce="<%= nonce %>">
            // Fonction pure pour générer le HTML pour le contenu du panier
            const generatePanierContent = (panier) => {
                return Object.entries(panier).map(([id, produit]) => `
        <div class="card mb-3" id="produit-${id}">
            <div class="card-body">
                <h5 class="card-title">${produit.nom}</h5>
                <p class="card-text">Quantité: ${produit.quantite}</p>
                <button class="btn btn-danger retirer-btn" data-id="${id}">Retirer</button>
            </div>
        </div>
    `).join('');
            };

            // Fonction pour mettre à jour le DOM avec le contenu du panier
            const updatePanierContent = (panierContent) => {
                document.getElementById('panierContent').innerHTML = panierContent;
                attachEventListenersToButtons();
            };

            // Fonction pour attacher les écouteurs d'événements aux boutons de retrait
            const attachEventListenersToButtons = () => {
                document.querySelectorAll('.retirer-btn').forEach(button => {
                    button.addEventListener('click', () => retirerDuPanier(button.getAttribute('data-id')));
                });
            };

            // Fonction pour retirer un produit du panier
            const retirerDuPanier = (id) => {
                const panier = getPanier();
                delete panier[id];
                sessionStorage.setItem('panier', JSON.stringify(panier));
                document.getElementById(`produit-${id}`).remove();
            };

            // Fonction pour récupérer le panier depuis le sessionStorage
            const getPanier = () => {
                return JSON.parse(sessionStorage.getItem('panier') || '{}');
            };

            // Fonction pour afficher le panier
            const afficherPanier = () => {
                const panier = getPanier();
                const panierContent = generatePanierContent(panier);
                updatePanierContent(panierContent);
            };

            // Fonction pour vider le panier
            const viderPanier = () => {
                sessionStorage.removeItem('panier');
                updatePanierContent('<p>Le panier a été vidé.</p>');
            };

            // Attachement des écouteurs d'événements
            document.addEventListener('DOMContentLoaded', afficherPanier);
            document.getElementById('viderPanier').addEventListener('click', viderPanier);

        </script>
</body>

</html>